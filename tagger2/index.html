<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="app">
    <div id="fonts">
      <link v-for="family in gf && gf.families ? gf.families : []" :href="family.url" rel="stylesheet">
    </div>
    <button @click="addFontPanel('Maven Pro')">Tags in font</button>
    <button @click="addCategoriesPanel(['/Expressive/Loud'])">Tags in category</button>
    <button @click="addVFViewPanel()">Font explorer</button>
    <button @click="addFontPanel('Maven Pro')">Add Font View</button>
    <button @click="addCategoriesPanel(['/Expressive/Loud'])">Add Tag View</button>
    <add-tag :categories="categories" @tag-added="addTag"></add-tag>
    <add-tags :categories="categories" @tags-added="addTags"></add-tags>
    <add-category @category-added="addCategory"></add-category>
    <div style="display: flex; flex-direction: row; width: 100vw; min-height: 100vh;">
      <div v-for="(panel, idx) in panels" :key="idx" :style="{ flex: '1 1 0', minWidth: 0, borderRight: idx < panels.length - 1 ? '1px solid #eee' : 'none', height: '100vh', overflow: 'auto' }">
        <panel
          :panel="panel"
          :tags="tags && tags.items ? tags.items : []"
          @remove="removePanel(idx)"
        ></panel>
      </div>
    </div>
  </div>
  <script type="module">
    import { GF, Tags, FontTag, FontTagGroup } from './models.js';
    import TagsByFont from "./TagsByFont.js";
    import TagsByCategories from "./TagsByCategories.js";
    import Panel from "./Panel.js";
    import TagView from "./TagView.js";
    import AddTag from "./AddTag.js";
    import AddTags from "./AddTags.js";
    import AddCategory from "./AddCategory.js";
    import VFView from "./VFView.js";
    import { linter } from "./linter.js";

    Vue.component('tags-by-font', TagsByFont);
    Vue.component('tags-by-categories', TagsByCategories);
    Vue.component('panel', Panel);
    Vue.component('tag-view', TagView);
    Vue.component('add-tag', AddTag);
    Vue.component("add-tags", AddTags);
    Vue.component('add-category', AddCategory);
    Vue.component('vf-view', VFView);
    
    var app = new Vue({
      el: '#app',
      data: {
        gf: null,
        tags: null,
        tagGroups: [],
        panels: [
          { type: 'font', font: 'Roboto' },
          { type: 'categories', categories: ['/Expressive/Loud', '/Expressive/Childlike'] }
        ],
      },
      methods: {
        addFontPanel(font) {
          this.panels.push({ type: 'font', font });
        },
        addCategoriesPanel(categories) {
          this.panels.push({ type: 'categories', categories , tagGroups: this.tagGroups });
        },
        addVFViewPanel() {
          this.panels.push({ type: 'vf-view', families: this.gf.families });
        },
        removePanel(idx) {
          this.panels.splice(idx, 1);
        },
        removeTag(tag) {
          const index = this.tags.items.indexOf(tag)
          if (index !== -1) {
            this.tags.items.splice(index, 1);
          }
        },
        addTag(tag) {
          const family = this.gf.families.find(f => f.name === tag.family);
          tag.family = family
          this.tags.items.push(tag);
        },
        addTags(filterSet) {
          for (let family of this.gf.families) {
            let addFamily = false;
            for (let axis of family.axes) {
              if (
                filterSet.lowTag.filters.some(f => f.axis == axis.tag) &&
                filterSet.highTag.filters.some(f => f.axis == axis.tag) &&
                filterSet.lowTag.filters.some(f => f.value >= axis.min) &&
                filterSet.highTag.filters.some(f => f.value <= axis.max)
              ) {
                addFamily = true;
              }
            }
            if (addFamily) {
              for (let category of filterSet.categories) {
                const lowTag = new FontTag(category, family, [{tag: "wght", value: 100}], filterSet.lowTag.score);
                const highTag = new FontTag(category, family, [{tag: "wght", value: 900}], filterSet.highTag.score);
                const fontTag = new FontTagGroup();
                fontTag.addTag(lowTag);
                fontTag.addTag(highTag);
                this.tagGroups.push(fontTag);
              }
            }
          }
        },
        addCategory(category) {
          console.log("Adding category", category);
          if (!this.tags.categories.includes(category)) {
            this.tags.categories.push(category);
          }
        },
      },
      computed: {
        categories() {
          return this.tags ? this.tags.categories : [];
        }
      },
      async created() {
        // Load the GF and Tags classes
        this.gf = new GF();
        await this.gf.getFamilyData();
        await this.gf.getLintRules();
        this.gf.loadFamilies();
        this.gf.linter = linter;
        this.tags = new Tags(this.gf);
        this.tags.sortCategories();

        // Subscribe to events
        this.$root.$on("remove-tag", this.removeTag);
        const family = this.gf.families.find(f => f.name === 'Maven Pro');
        const tag1 = new FontTag('/Purpose/Easy Reading', family, [{tag: "wght", value: 400}], 10);
        const tag2 = new FontTag('/Purpose/Easy Reading', family, [{tag: "wght", value: 900}], 100);
        const tagGroup = new FontTagGroup();
        tagGroup.addTag(tag1);
        tagGroup.addTag(tag2);
        this.tagGroups.push(tagGroup);
      }
    });
    window.app = app
  </script>
</body>
</html>